<div class="accounts-page">

  <div class="page-toolbar">
    <button class="btn-primary" (click)="openCreateModal()">
      <span class="material-symbols-rounded">add_card</span>
      Nueva Cuenta
    </button>
  </div>

  <div *ngIf="isLoading()" class="loading-grid">
    <div class="spinner"></div>
    <p>Sincronizando billeteras...</p>
  </div>

  <div *ngIf="!isLoading()" class="accounts-content">

    <section class="account-section">
      <div class="section-header">
        <h3 class="section-title">
          <span class="material-symbols-rounded icon">account_balance_wallet</span>
          Activos Disponibles
        </h3>
        <div class="divider-line"></div>
      </div>

      <div class="cards-grid">
        <app-account-card
          *ngFor="let acc of debitAccounts()"
          [account]="acc"
          (edit)="openEditModal($event)"
          (delete)="deleteAccount($event)">
        </app-account-card>

        <div *ngIf="debitAccounts().length === 0" class="empty-msg">
          No tienes cuentas de débito o efectivo registradas.
        </div>
      </div>
    </section>

    <section class="account-section">
      <div class="section-header">
        <h3 class="section-title">
          <span class="material-symbols-rounded icon">credit_card</span>
          Tarjetas de Crédito
        </h3>
        <div class="divider-line"></div>
      </div>

      <div class="cards-grid credit-grid">
        <app-credit-card
          *ngFor="let acc of creditAccounts()"
          [account]="acc"
          (edit)="openEditModal($event)"
          (delete)="deleteAccount($event)">
        </app-credit-card>

        <div *ngIf="creditAccounts().length === 0" class="empty-msg">
          ¡Libre de deudas! No tienes tarjetas de crédito activas.
        </div>
      </div>
    </section>

  </div>

</div>

<app-modal [isOpen]="isModalOpen()"
           [title]="editingAccountId() ? 'Editar Cuenta' : 'Nueva Cuenta'"
           (close)="closeModal()">

  <form [formGroup]="accountForm" (ngSubmit)="onSubmit()" class="modal-form">

    <div class="form-group">
      <label>Nombre de la Cuenta</label>
      <input type="text" formControlName="name" placeholder="Ej: Visa Signature" class="form-input">
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Tipo</label>
        <select formControlName="type" class="form-select">
          <option *ngFor="let type of eAccountType" [value]="type">{{ type }}</option>
        </select>
      </div>
      <div class="form-group">
        <label>Moneda</label>
        <select formControlName="currency" class="form-select">
          <option *ngFor="let curr of eCurrency" [value]="curr">{{ curr }}</option>
        </select>
      </div>
    </div>

    <div class="form-group" *ngIf="accountForm.get('type')?.value !== 'EFECTIVO'">
      <label>Entidad Bancaria</label>
      <input type="text" formControlName="bankName" placeholder="Ej: BCP, BBVA" class="form-input">
    </div>

    <div class="credit-section" *ngIf="isCreditCard">

      <div class="form-group" style="margin-bottom: 1rem;">
        <label>Línea de Crédito Total</label>
        <div class="input-group">
          <span class="prefix">{{ accountForm.get('currency')?.value === 'PEN' ? 'S/' : '$' }}</span>
          <input type="number" formControlName="creditLimit" class="form-input" placeholder="Ej: 5000">
        </div>
      </div>

      <div class="form-row" style="margin-bottom: 1rem;">
        <div class="form-group">
          <label>Día de Cierre</label>
          <select formControlName="closingDate" class="form-select">
            <option [ngValue]="null" disabled>Elegir</option>
            <option *ngFor="let day of daysOfMonth" [value]="day">{{ day }}</option>
          </select>
        </div>
        <div class="form-group">
          <label>Día de Pago</label>
          <select formControlName="paymentDate" class="form-select">
            <option [ngValue]="null" disabled>Elegir</option>
            <option *ngFor="let day of daysOfMonth" [value]="day">{{ day }}</option>
          </select>
        </div>
      </div>

      <div class="form-group" *ngIf="!editingAccountId()">
        <label style="color: var(--color-primary); margin-bottom: 0.5rem; display:block;">Inicialización de Deuda</label>

        <div class="form-row">
          <div class="form-group">
            <label title="Monto que ya cerró">Facturado</label>
            <div class="input-group">
              <span class="prefix">{{ accountForm.get('currency')?.value === 'PEN' ? 'S/' : '$' }}</span>
              <input type="number" formControlName="previousBalance" class="form-input" placeholder="0.00">
            </div>
          </div>

          <div class="form-group">
            <label title="Consumos del mes en curso">Consumo Actual</label>
            <div class="input-group">
              <span class="prefix">{{ accountForm.get('currency')?.value === 'PEN' ? 'S/' : '$' }}</span>
              <input type="number" formControlName="currentBalance" class="form-input" placeholder="0.00">
            </div>
          </div>
        </div>
        <p class="helper-text">
          Ingresa por separado la deuda que ya cerró y tus consumos nuevos.
        </p>
      </div>

    </div>

    <div class="form-group" *ngIf="!isCreditCard">
      <label>Saldo Actual</label>
      <div class="input-group">
        <span class="prefix">{{ accountForm.get('currency')?.value === 'PEN' ? 'S/' : '$' }}</span>
        <input type="number" formControlName="initialBalance" class="form-input">
      </div>
    </div>

    <div class="form-actions">
      <button type="button" class="btn-cancel" (click)="closeModal()">Cancelar</button>
      <button type="submit" class="btn-primary" [disabled]="accountForm.invalid || isSubmitting()">
        {{ isSubmitting() ? 'Guardando...' : (editingAccountId() ? 'Actualizar' : 'Crear Cuenta') }}
      </button>
    </div>
  </form>
</app-modal>
